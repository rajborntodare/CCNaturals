<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#070d0a" />
  <title>Pro Cosmetic Chemist AI</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      background: #070d0a;
      color: #e8f5e9;
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
    }
    * { scrollbar-width: thin; scrollbar-color: #2d6a4f #0d1a12; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0d1a12; }
    ::-webkit-scrollbar-thumb { background: #2d6a4f; border-radius: 3px; }

    @keyframes bounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-7px)} }
    @keyframes fadeSlide { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    @keyframes slideUp { from{opacity:0;transform:translateY(40px)} to{opacity:1;transform:translateY(0)} }

    /* â”€â”€ API KEY GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #api-gate {
      display: none; position: fixed; inset: 0; z-index: 9999;
      background: #070d0a; flex-direction: column;
      align-items: center; justify-content: center; padding: 28px 24px;
    }
    #api-gate.visible { display: flex; }
    .gate-card {
      width: 100%; max-width: 400px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(82,183,136,0.25);
      border-radius: 20px; padding: 30px 24px;
      animation: slideUp 0.4s ease;
    }
    .gate-logo {
      width: 60px; height: 60px; border-radius: 16px;
      background: linear-gradient(135deg, #1b4332, #52b788);
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; margin: 0 auto 18px;
      box-shadow: 0 0 24px rgba(82,183,136,0.4);
    }
    .gate-title { color: #a8d8a8; font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 6px; }
    .gate-sub { color: #52b78890; font-size: 13px; text-align: center; margin-bottom: 24px; line-height: 1.5; }
    .gate-label { color: #74c69d; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 8px; display: block; }
    .gate-input {
      width: 100%; padding: 13px 14px;
      background: rgba(0,0,0,0.3); border: 1px solid rgba(82,183,136,0.3);
      border-radius: 12px; color: #e8f5e9;
      font-size: 14px; font-family: monospace;
      outline: none; margin-bottom: 8px;
    }
    .gate-input:focus { border-color: #52b788; }
    .gate-hint { color: #52b78870; font-size: 11px; margin-bottom: 20px; line-height: 1.6; }
    .gate-btn {
      width: 100%; padding: 14px;
      background: linear-gradient(135deg, #1b4332, #2d6a4f);
      border: 1px solid #52b78860; border-radius: 12px;
      color: #a8d8a8; font-size: 15px; font-weight: 700;
      font-family: inherit; cursor: pointer;
    }
    .gate-btn:active { opacity: 0.75; }
    .gate-error { color: #ff8a80; font-size: 12px; text-align: center; margin-top: 10px; min-height: 18px; }
    .gate-testing { color: #74c69d; font-size: 12px; text-align: center; margin-top: 10px; display: none; }
    .gate-testing.visible { display: block; }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      height: 58px; min-height: 58px;
      background: rgba(10,26,17,0.97);
      border-bottom: 1px solid rgba(82,183,136,0.15);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 14px; z-index: 100;
    }
    #header-left { display: flex; align-items: center; gap: 10px; }
    #logo-icon {
      width: 36px; height: 36px; border-radius: 9px;
      background: linear-gradient(135deg, #1b4332, #52b788);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; box-shadow: 0 0 14px rgba(82,183,136,0.3);
    }
    #logo-title { font-size: 13px; font-weight: 700; color: #a8d8a8; }
    #logo-sub { font-size: 10px; color: #52b78868; letter-spacing: 0.8px; }
    #status-dot { width: 7px; height: 7px; border-radius: 50%; background: #52b788; animation: pulse 2s infinite; }
    #status-label { font-size: 11px; color: #52b78888; }

    /* â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tabbar { display: flex; background: rgba(10,26,17,0.95); border-bottom: 1px solid rgba(82,183,136,0.1); }
    .tab-btn {
      flex: 1; padding: 9px 4px; background: none; border: none;
      color: #52b78870; cursor: pointer; font-size: 10px; font-family: inherit;
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      border-bottom: 2px solid transparent; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn .ti { font-size: 17px; }
    .tab-btn.active { color: #a8d8a8; border-bottom-color: #52b788; background: rgba(82,183,136,0.05); }

    /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    .tab-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .tab-panel.active { display: flex; }

    /* â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #messages { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
    .msg-row { display: flex; align-items: flex-end; gap: 8px; animation: fadeSlide 0.3s ease; }
    .msg-row.user { flex-direction: row-reverse; }
    .avatar { width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .avatar.ai { background: linear-gradient(135deg, #2d6a4f, #52b788); }
    .avatar.user { background: linear-gradient(135deg, #0d2818, #1b4332); border: 1px solid #52b78840; }
    .bubble { max-width: 82%; padding: 10px 14px; font-size: 14px; line-height: 1.7; }
    .bubble.ai { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 4px 16px 16px 16px; }
    .bubble.user { background: linear-gradient(135deg, #1b4332, #2d6a4f); border: 1px solid #52b78840; border-radius: 16px 16px 4px 16px; }
    .msg-time { font-size: 10px; color: #52b78868; margin-top: 4px; }

    /* â”€â”€ MARKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md p { margin: 0 0 8px; }
    .md p:last-child { margin-bottom: 0; }
    .md strong { color: #a8d8a8; font-weight: 700; }
    .md em { color: #74c69d; }
    .md h2 { color: #74c69d; font-size: 1em; margin: 14px 0 6px; border-bottom: 1px solid #52b78830; padding-bottom: 3px; }
    .md h3 { color: #95d5b2; font-size: 0.95em; margin: 10px 0 5px; }
    .md h4 { color: #b7e4c7; font-size: 0.9em; margin: 8px 0 4px; }
    .md ul { margin: 4px 0 8px 16px; }
    .md li { margin-bottom: 3px; }
    .md code { background: rgba(82,183,136,0.15); color: #95d5b2; padding: 1px 5px; border-radius: 4px; font-family: monospace; font-size: 0.88em; }
    .md hr { border: none; border-top: 1px solid #52b78830; margin: 12px 0; }
    .md table { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 12px; display: block; overflow-x: auto; }
    .md th { background: rgba(82,183,136,0.2); color: #a8d8a8; font-weight: 700; padding: 6px 8px; text-align: left; border: 1px solid #52b78830; white-space: nowrap; }
    .md td { padding: 5px 8px; border: 1px solid #52b78820; color: #d8f3dc; }
    .md tr:nth-child(even) td { background: rgba(255,255,255,0.02); }

    /* â”€â”€ TYPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #typing { display: none; align-items: flex-end; gap: 8px; padding: 0 14px 8px; }
    #typing.visible { display: flex; }
    .dot-wrap { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 4px 16px 16px 16px; padding: 11px 15px; display: flex; gap: 5px; align-items: center; }
    .dot { width: 7px; height: 7px; border-radius: 50%; background: #a8d8a8; animation: bounce 1.2s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    /* â”€â”€ QUICK PROMPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #quick-wrap { padding: 7px 12px 5px; border-top: 1px solid rgba(82,183,136,0.08); overflow-x: auto; white-space: nowrap; display: flex; gap: 7px; }
    .quick-btn { flex-shrink: 0; background: rgba(82,183,136,0.08); border: 1px solid rgba(82,183,136,0.22); color: #74c69d; border-radius: 20px; padding: 5px 12px; cursor: pointer; font-size: 12px; font-family: inherit; -webkit-tap-highlight-color: transparent; }
    .quick-btn:active { background: rgba(82,183,136,0.2); }

    /* â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-wrap { padding: 10px 12px 14px; background: rgba(10,26,17,0.6); border-top: 1px solid rgba(82,183,136,0.1); }
    #input-row { display: flex; gap: 8px; align-items: flex-end; background: rgba(255,255,255,0.04); border: 1px solid rgba(82,183,136,0.25); border-radius: 16px; padding: 9px 12px; }
    #input-row:focus-within { border-color: #52b78860; }
    #msg-input { flex: 1; background: none; border: none; outline: none; color: #e8f5e9; font-size: 14px; font-family: inherit; resize: none; line-height: 1.6; max-height: 100px; overflow-y: auto; }
    #msg-input::placeholder { color: #52b78850; }
    #send-btn { width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0; background: #1b4332; border: 1px solid #52b788; color: #a8d8a8; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
    #send-btn:disabled { background: rgba(82,183,136,0.08); border-color: #52b78830; color: #52b78840; }
    #send-btn:not(:disabled):active { transform: scale(0.92); }
    #input-hint { font-size: 10px; color: #52b78845; text-align: center; margin-top: 5px; }

    /* â”€â”€ LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #library-scroll { flex: 1; overflow-y: auto; padding: 14px; }
    .lib-header { margin-bottom: 14px; }
    .lib-header h2 { color: #a8d8a8; font-size: 17px; margin-bottom: 3px; }
    .lib-header p { color: #52b78878; font-size: 12px; }
    .lib-empty { text-align: center; padding: 48px 20px; color: #52b78858; border: 1px dashed rgba(82,183,136,0.18); border-radius: 16px; }
    .li-icon { font-size: 38px; margin-bottom: 10px; }
    .li-title { font-size: 14px; color: #52b788; margin-bottom: 5px; }
    .li-sub { font-size: 12px; }
    .formula-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(82,183,136,0.15); border-radius: 12px; padding: 13px; margin-bottom: 10px; }
    .fc-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
    .fc-title { color: #a8d8a8; font-weight: 700; font-size: 13px; margin-bottom: 2px; }
    .fc-meta { color: #52b78878; font-size: 11px; }
    .fc-preview { color: #e8f5e978; font-size: 11px; margin-top: 5px; line-height: 1.5; }
    .fc-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .load-btn, .del-btn { padding: 5px 10px; border-radius: 7px; cursor: pointer; font-size: 11px; font-family: inherit; border: 1px solid; -webkit-tap-highlight-color: transparent; }
    .load-btn { background: rgba(82,183,136,0.1); border-color: #52b78838; color: #a8d8a8; }
    .del-btn { background: rgba(220,50,50,0.07); border-color: rgba(220,50,50,0.22); color: #ff8a80; }
    #save-bar { padding: 10px 14px 14px; border-top: 1px solid rgba(82,183,136,0.08); display: flex; gap: 8px; }
    .action-btn { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid; cursor: pointer; font-size: 13px; font-family: inherit; font-weight: 600; -webkit-tap-highlight-color: transparent; }
    .action-btn:active { opacity: 0.7; }
    .btn-new { background: linear-gradient(135deg, #1b4332, #2d6a4f); border-color: #52b78840; color: #a8d8a8; }
    .btn-save { background: rgba(82,183,136,0.07); border-color: #52b78828; color: #74c69d; }

    /* â”€â”€ GUIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #guide-scroll { flex: 1; overflow-y: auto; padding: 14px; }
    #guide-scroll h2 { color: #a8d8a8; font-size: 17px; margin-bottom: 14px; }
    .guide-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(82,183,136,0.12); border-radius: 12px; padding: 13px; margin-bottom: 9px; display: flex; gap: 11px; }
    .guide-icon { font-size: 22px; flex-shrink: 0; line-height: 1; margin-top: 2px; }
    .guide-title { color: #a8d8a8; font-weight: 700; margin-bottom: 3px; font-size: 13px; }
    .guide-body { color: #d8f3dc78; font-size: 12px; line-height: 1.6; }
    .example-box { background: rgba(82,183,136,0.05); border: 1px solid rgba(82,183,136,0.18); border-radius: 12px; padding: 14px; margin-top: 14px; }
    .example-box h3 { color: #74c69d; font-size: 13px; font-weight: 700; margin-bottom: 10px; }
    .example-prompt { display: block; width: 100%; background: none; border: none; border-bottom: 1px solid rgba(82,183,136,0.1); color: #74c69d78; text-align: left; cursor: pointer; padding: 8px 0; font-size: 12px; font-family: inherit; -webkit-tap-highlight-color: transparent; }
    .example-prompt:last-child { border-bottom: none; }
    .example-prompt:active { color: #a8d8a8; }

    /* â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #settings-scroll { flex: 1; overflow-y: auto; padding: 14px; }
    #settings-scroll h2 { color: #a8d8a8; font-size: 17px; margin-bottom: 4px; }
    .settings-sub { color: #52b78878; font-size: 12px; margin-bottom: 20px; }
    .settings-section { background: rgba(255,255,255,0.03); border: 1px solid rgba(82,183,136,0.15); border-radius: 14px; padding: 16px; margin-bottom: 14px; }
    .st-section-title { color: #74c69d; font-size: 11px; font-weight: 700; letter-spacing: 0.8px; margin-bottom: 12px; }
    .st-label { color: #a8d8a8; font-size: 13px; font-weight: 600; margin-bottom: 6px; display: block; }
    .st-desc { color: #52b78878; font-size: 11px; margin-bottom: 10px; line-height: 1.5; }
    .st-input { width: 100%; padding: 12px 13px; background: rgba(0,0,0,0.3); border: 1px solid rgba(82,183,136,0.28); border-radius: 11px; color: #e8f5e9; font-size: 13px; font-family: monospace; outline: none; margin-bottom: 10px; }
    .st-input:focus { border-color: #52b788; }
    .st-btn { width: 100%; padding: 13px; border-radius: 11px; border: 1px solid #52b78848; background: linear-gradient(135deg, #1b4332, #2d6a4f); color: #a8d8a8; font-size: 14px; font-weight: 700; font-family: inherit; cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .st-btn:active { opacity: 0.75; }
    .st-btn.danger { background: rgba(220,50,50,0.12); border-color: rgba(220,50,50,0.3); color: #ff8a80; }
    .key-status { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; font-size: 12px; margin-bottom: 12px; }
    .key-status.ok { background: rgba(82,183,136,0.1); border: 1px solid rgba(82,183,136,0.25); color: #74c69d; }
    .key-status.missing { background: rgba(220,100,50,0.1); border: 1px solid rgba(220,100,50,0.25); color: #ffab76; }
    .ks-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .key-status.ok .ks-dot { background: #52b788; animation: pulse 2s infinite; }
    .key-status.missing .ks-dot { background: #ff8a80; }
    .info-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(82,183,136,0.08); font-size: 12px; }
    .info-row:last-child { border-bottom: none; }
    .info-key { color: #52b78890; }
    .info-val { color: #a8d8a8; font-weight: 600; }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(45,106,79,0.96); color: #a8d8a8; padding: 10px 20px; border-radius: 20px; font-size: 13px; border: 1px solid #52b788; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 9998; white-space: nowrap; }
    #toast.show { opacity: 1; }
    #toast.err { background: rgba(150,30,30,0.96); border-color: #ff6060; color: #ffcdd2; }
  </style>
</head>
<body>

<!-- API KEY GATE -->
<div id="api-gate">
  <div class="gate-card">
    <div class="gate-logo">âš—ï¸</div>
    <div class="gate-title">Pro Cosmetic Chemist AI</div>
    <div class="gate-sub">Enter your Anthropic API key to get started.<br>Stored only on this device â€” never shared.</div>
    <label class="gate-label">ANTHROPIC API KEY</label>
    <input type="password" id="gate-key" class="gate-input" placeholder="sk-ant-api03-â€¦" autocomplete="off" spellcheck="false" />
    <div class="gate-hint">
      ğŸ”‘ Get a free key at <strong>console.anthropic.com</strong><br>
      Go to API Keys â†’ Create Key â†’ paste it above.
    </div>
    <button class="gate-btn" onclick="submitApiKey()">Connect &amp; Start â†’</button>
    <div class="gate-testing" id="gate-testing">â³ Testing connectionâ€¦</div>
    <div class="gate-error" id="gate-error"></div>
  </div>
</div>

<!-- HEADER -->
<div id="header">
  <div id="header-left">
    <div id="logo-icon">âš—ï¸</div>
    <div>
      <div id="logo-title">PRO CHEMIST AI</div>
      <div id="logo-sub">FORMULATION EXPERT</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <div id="status-dot"></div>
    <span id="status-label">Ready</span>
  </div>
</div>

<!-- TAB BAR -->
<div id="tabbar">
  <button class="tab-btn active" data-tab="chat" onclick="switchTab('chat')"><span class="ti">ğŸ’¬</span>Chat</button>
  <button class="tab-btn" data-tab="library" onclick="switchTab('library')"><span class="ti">ğŸ“š</span>Library</button>
  <button class="tab-btn" data-tab="guide" onclick="switchTab('guide')"><span class="ti">ğŸ“–</span>Guide</button>
  <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')"><span class="ti">âš™ï¸</span>Settings</button>
</div>

<!-- MAIN -->
<div id="main">

  <!-- CHAT -->
  <div id="chat" class="tab-panel active">
    <div id="messages"></div>
    <div id="typing">
      <div class="avatar ai">ğŸ‘©â€ğŸ”¬</div>
      <div class="dot-wrap"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
    <div id="quick-wrap"></div>
    <div id="input-wrap">
      <div id="input-row">
        <textarea id="msg-input" rows="1" placeholder="Describe the product you want to formulateâ€¦"
          oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
        <button id="send-btn" disabled onclick="sendMessage()">â†‘</button>
      </div>
      <div id="input-hint">Pro Cosmetic Chemist AI Â· Claude Sonnet 4</div>
    </div>
  </div>

  <!-- LIBRARY -->
  <div id="library" class="tab-panel" style="flex-direction:column;">
    <div id="library-scroll">
      <div class="lib-header">
        <h2>ğŸ“š Formula Library</h2>
        <p id="lib-count">0 saved sessions</p>
      </div>
      <div id="lib-list"></div>
    </div>
    <div id="save-bar">
      <button class="action-btn btn-new" onclick="newSession()">+ New Session</button>
      <button class="action-btn btn-save" onclick="saveSession()">ğŸ’¾ Save Session</button>
    </div>
  </div>

  <!-- GUIDE -->
  <div id="guide" class="tab-panel">
    <div id="guide-scroll">
      <h2>ğŸ“– How to Use</h2>
      <div class="guide-card"><div class="guide-icon">ğŸ§ª</div><div><div class="guide-title">Request a Formula</div><div class="guide-body">Describe the product type, skin/hair concern, key actives, and any restrictions. The AI generates a complete batch-ready formula with INCI list and process notes.</div></div></div>
      <div class="guide-card"><div class="guide-icon">âš—ï¸</div><div><div class="guide-title">Batch Process Design</div><div class="guide-body">Phase temperatures, mixing speeds, order of addition, emulsification and finishing steps â€” ready for lab or pilot-scale manufacturing.</div></div></div>
      <div class="guide-card"><div class="guide-icon">ğŸ”„</div><div><div class="guide-title">Modify & Iterate</div><div class="guide-body">Swap ingredients, adjust percentages, go natural/vegan, reduce cost, or create premium variations in real time.</div></div></div>
      <div class="guide-card"><div class="guide-icon">ğŸ“Š</div><div><div class="guide-title">Stability & Regulatory</div><div class="guide-body">pH targets, preservation system, compatibility notes, shelf-life expectations, EU/US guidance.</div></div></div>
      <div class="guide-card"><div class="guide-icon">âš™ï¸</div><div><div class="guide-title">API Key Required</div><div class="guide-body">This app uses your personal Anthropic API key. Go to Settings to update it anytime. Get one free at console.anthropic.com.</div></div></div>
      <div class="example-box">
        <h3>ğŸ’¡ Tap to Try</h3>
        <button class="example-prompt" onclick="tryExample(this)">â†’ 2% salicylic acid toner for acne-prone skin, alcohol-free</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Natural SPF 30 mineral sunscreen â€” non-nano zinc oxide, EU compliant</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Vegan, Cosmos-certified hair conditioner for curly hair</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Vitamin C serum with L-ascorbic acid at pH 3.2, stable 18 months</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Rich body butter for very dry skin with ceramides and shea</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settings" class="tab-panel">
    <div id="settings-scroll">
      <h2>âš™ï¸ Settings</h2>
      <p class="settings-sub">Manage your API key and app data</p>

      <div class="settings-section">
        <div class="st-section-title">ğŸ”‘ ANTHROPIC API KEY</div>
        <div id="key-status-el"></div>
        <label class="st-label">Update API Key</label>
        <div class="st-desc">Get your key at <strong style="color:#74c69d">console.anthropic.com</strong> â†’ API Keys â†’ Create Key.<br>Stored locally on your device only.</div>
        <input type="password" id="st-key-input" class="st-input" placeholder="sk-ant-api03-â€¦" autocomplete="off" spellcheck="false" />
        <button class="st-btn" onclick="saveApiKey()">Save &amp; Verify Key</button>
      </div>

      <div class="settings-section">
        <div class="st-section-title">ğŸ“± APP INFO</div>
        <div class="info-row"><span class="info-key">App</span><span class="info-val">Pro Cosmetic Chemist AI</span></div>
        <div class="info-row"><span class="info-key">Version</span><span class="info-val">1.1.0</span></div>
        <div class="info-row"><span class="info-key">AI Model</span><span class="info-val">Claude Sonnet 4</span></div>
        <div class="info-row"><span class="info-key">Saved Sessions</span><span class="info-val" id="st-count">0</span></div>
      </div>

      <div class="settings-section">
        <div class="st-section-title">âš ï¸ DATA</div>
        <div class="st-desc">Permanently delete all saved formula sessions from this device.</div>
        <button class="st-btn danger" onclick="clearAllData()">Clear All Saved Sessions</button>
      </div>
    </div>
  </div>

</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYS = `You are an expert cosmetic chemist with deep experience in R&D, formulation science, raw material selection, stability considerations, regulatory constraints, and manufacturing processes. You think like a senior formulator who creates real-world, batch-ready cosmetic formulas.

When the user provides requirements:
1. Generate a complete formula: product type, full INCI list, percentage composition (total=100%), phase-by-phase breakdown, ingredient rationale, substitutes.
2. Provide a detailed batch process: phase temperatures, mixing speeds, order of addition, emulsification, cooling/finishing steps.
3. Explain stability: pH targets, preservation justification, viscosity, compatibility notes.
4. Adapt to user constraints: ingredient restrictions, natural/organic, cost limits, regional regulations.

Always use this output structure:

**1. Product Overview**
- Product type / Key claims / Texture / Skin or hair type suitability

**2. Full Formula (100%)**
| Phase | INCI Name | Trade Name | % | Function |

**3. Ingredient Rationale**
Short explanation for each key ingredient.

**4. Demo Batch Process**
Step-by-step with temperatures, mixing notes, finishing steps.

**5. Stability & Regulatory Notes**
- pH range / Preservation system / Incompatibilities / Shelf life

**6. Optional Variations**
Cost-reduced / Premium / Natural versions.

After each formula ask: "Would you like to modify any ingredients, adjust the texture, change the claims, or create variations?"

Be precise and technical. Never hallucinate ingredients or unsafe combinations.`;

const QUICK_PROMPTS = [
  { icon:"ğŸ§´", label:"Moisturizer", prompt:"Formulate a lightweight moisturizer for oily skin with niacinamide and hyaluronic acid." },
  { icon:"ğŸ§¼", label:"Cleanser",   prompt:"Create a gentle sulfate-free facial cleanser for sensitive skin." },
  { icon:"â˜€ï¸", label:"SPF 30",     prompt:"Formulate an SPF 30 broad-spectrum sunscreen â€” EU-compliant, elegant skin feel." },
  { icon:"ğŸ’†", label:"Shampoo",    prompt:"Design a sulfate-free shampoo for damaged hair with protein complex." },
  { icon:"âœ¨", label:"Serum",      prompt:"Create a 10% Vitamin C serum with ferulic acid, stable at pH 3.2." },
  { icon:"ğŸ’„", label:"Lip Balm",   prompt:"Formulate a nourishing lip balm with SPF 15 and natural waxes." },
  { icon:"ğŸ«§", label:"Body Lotion",prompt:"Develop a rich body lotion for dry skin with ceramides and shea butter." },
  { icon:"ğŸŒ¿", label:"Natural",    prompt:"95%+ natural Cosmos-certified face oil serum for mature skin." },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let messages=[], history=[], sessionTitle="New Session", formulas=[], isLoading=false, apiKey='';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  apiKey = localStorage.getItem('cc_api_key') || '';
  formulas = JSON.parse(localStorage.getItem('cc_formulas') || '[]');
  if (!apiKey) {
    document.getElementById('api-gate').classList.add('visible');
  } else {
    boot();
  }
});

function boot() {
  buildQuicks();
  addMsg('ai', `Welcome to **Pro Cosmetic Chemist AI**!\n\nI can help you:\n- ğŸ§ª **Formulate** any cosmetic product (skincare, haircare, color, sun care)\n- âš—ï¸ **Design batch processes** with phase temperatures & mixing protocols\n- ğŸ“Š **Optimize stability**, preservation, and pH targets\n- ğŸŒ¿ **Adapt** to natural, vegan, cost-reduced, or premium requirements\n\nTell me what you'd like to create, or tap a quick-start button below.`);
  document.getElementById('msg-input').addEventListener('input', updateSendBtn);
  renderLib();
  refreshSettings();
}

function buildQuicks() {
  const w = document.getElementById('quick-wrap');
  w.innerHTML = '';
  QUICK_PROMPTS.forEach(q => {
    const b = document.createElement('button');
    b.className = 'quick-btn';
    b.textContent = q.icon+' '+q.label;
    b.onclick = () => sendText(q.prompt);
    w.appendChild(b);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY GATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitApiKey() {
  const key = document.getElementById('gate-key').value.trim();
  const errEl = document.getElementById('gate-error');
  const testEl = document.getElementById('gate-testing');
  errEl.textContent = '';
  if (!key.startsWith('sk-ant-')) { errEl.textContent = 'âš ï¸ Key should start with sk-ant-â€¦'; return; }
  testEl.classList.add('visible');
  try {
    if (await verifyKey(key)) {
      localStorage.setItem('cc_api_key', key);
      apiKey = key;
      document.getElementById('api-gate').classList.remove('visible');
      boot();
      toast('âœ… Connected! Ready to formulate.');
    } else {
      errEl.textContent = 'âŒ Invalid key or API error. Please check and retry.';
    }
  } catch(e) {
    errEl.textContent = 'âŒ Network error: ' + e.message;
  } finally {
    testEl.classList.remove('visible');
  }
}

async function verifyKey(key) {
  try {
    const r = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key': key,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body: JSON.stringify({ model:'claude-haiku-4-5-20251001', max_tokens:5, messages:[{role:'user',content:'Hi'}] })
    });
    return r.ok;
  } catch { return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshSettings() {
  const key = localStorage.getItem('cc_api_key') || '';
  document.getElementById('key-status-el').innerHTML = key
    ? `<div class="key-status ok"><div class="ks-dot"></div>Key saved Â· ${key.slice(0,18)}â€¦</div>`
    : `<div class="key-status missing"><div class="ks-dot"></div>No API key â€” add one below</div>`;
  document.getElementById('st-count').textContent = formulas.length;
}

async function saveApiKey() {
  const key = document.getElementById('st-key-input').value.trim();
  if (!key) { toast('Enter a key first', true); return; }
  if (!key.startsWith('sk-ant-')) { toast('Key should start with sk-ant-â€¦', true); return; }
  toast('â³ Verifyingâ€¦');
  try {
    if (await verifyKey(key)) {
      localStorage.setItem('cc_api_key', key);
      apiKey = key;
      document.getElementById('st-key-input').value = '';
      refreshSettings();
      toast('âœ… API key saved!');
    } else {
      toast('âŒ Key invalid or error', true);
    }
  } catch { toast('âŒ Network error', true); }
}

function clearAllData() {
  if (!confirm('Delete all saved sessions? Cannot be undone.')) return;
  formulas = [];
  localStorage.removeItem('cc_formulas');
  renderLib();
  refreshSettings();
  toast('All sessions cleared');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab===name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id===name));
  if (name==='library') renderLib();
  if (name==='settings') refreshSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMsg(role, content) {
  const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const obj = {role, content, time};
  messages.push(obj);
  renderMsg(obj);
  history.push({role: role==='ai'?'assistant':role, content});
  scrollBot();
}

function renderMsg(m) {
  const c = document.getElementById('messages');
  const row = document.createElement('div');
  row.className = 'msg-row '+(m.role==='user'?'user':'ai');
  const av = document.createElement('div');
  av.className = 'avatar '+(m.role==='user'?'user':'ai');
  av.textContent = m.role==='user'?'ğŸ§‘â€ğŸ’¼':'ğŸ‘©â€ğŸ”¬';
  const bub = document.createElement('div');
  bub.className = 'bubble '+(m.role==='user'?'user':'ai');
  if (m.role!=='user') {
    const md = document.createElement('div');
    md.className='md'; md.innerHTML=parseMd(m.content);
    bub.appendChild(md);
  } else { bub.textContent=m.content; }
  const t=document.createElement('div'); t.className='msg-time'; t.textContent=m.time;
  bub.appendChild(t);
  if (m.role==='user'){row.appendChild(bub);row.appendChild(av);}
  else{row.appendChild(av);row.appendChild(bub);}
  c.appendChild(row);
}

function parseMd(txt) {
  let h = txt
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^### (.+)$/gm,'<h4>$1</h4>')
    .replace(/^## (.+)$/gm,'<h3>$1</h3>')
    .replace(/^# (.+)$/gm,'<h2>$1</h2>')
    .replace(/`(.+?)`/g,'<code>$1</code>')
    .replace(/^- (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>[\s\S]+?<\/li>\n?)+/g, m=>'<ul>'+m+'</ul>')
    .replace(/^---$/gm,'<hr>')
    .replace(/^\|(.+)\|$/gm, row=>{
      const cells=row.split('|').slice(1,-1);
      if(cells.every(c=>/^[-: ]+$/.test(c.trim())))return'';
      const isH=cells.some(c=>['Phase','INCI Name','Ingredient','Trade Name'].includes(c.trim()));
      const tag=isH?'th':'td';
      return'<tr>'+cells.map(c=>`<${tag}>${c.trim()}</${tag}>`).join('')+'</tr>';
    })
    .replace(/(<tr>[\s\S]+?<\/tr>\n?)+/g,m=>'<table>'+m+'</table>')
    .replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>');
  return '<p>'+h+'</p>';
}

function scrollBot() {
  setTimeout(()=>{ const e=document.getElementById('messages'); e.scrollTop=e.scrollHeight; },60);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }

function sendMessage() {
  const el=document.getElementById('msg-input');
  const txt=el.value.trim(); if(!txt)return;
  el.value=''; el.style.height='auto'; updateSendBtn();
  sendText(txt);
}

async function sendText(txt) {
  if(!txt||isLoading)return;
  if(!apiKey){ toast('âš ï¸ No API key â€” go to Settings',true); switchTab('settings'); return; }
  if(messages.length<=1) sessionTitle=txt.slice(0,42)+(txt.length>42?'â€¦':'');
  addMsg('user',txt);
  isLoading=true;
  document.getElementById('typing').classList.add('visible');
  document.getElementById('send-btn').disabled=true;
  document.getElementById('status-label').textContent='Thinkingâ€¦';
  scrollBot();
  try {
    const reply = await callAPI();
    addMsg('ai', reply);
    document.getElementById('status-label').textContent='Ready';
  } catch(e) {
    let msg=e.message;
    if(msg.includes('401'))msg='Invalid API key â€” go to Settings to update it';
    else if(msg.includes('429'))msg='Rate limit reached â€” wait a moment and retry';
    else if(msg.includes('fetch')||msg.includes('Failed'))msg='No internet connection â€” check your network';
    addMsg('ai','âš ï¸ '+msg);
    document.getElementById('status-label').textContent='Error';
  } finally {
    isLoading=false;
    document.getElementById('typing').classList.remove('visible');
    updateSendBtn();
  }
}

async function callAPI() {
  const apiMsgs = history.slice(); // already includes the user msg just added
  const res = await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key': apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model:'claude-sonnet-4-20250514',
      max_tokens:4096,
      system:SYS,
      messages:apiMsgs
    })
  });
  if(!res.ok){
    let err={};
    try{err=await res.json();}catch{}
    throw new Error(err.error?.message||`HTTP ${res.status}`);
  }
  const data=await res.json();
  return data.content.map(b=>b.text||'').join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }
function updateSendBtn(){ document.getElementById('send-btn').disabled=!document.getElementById('msg-input').value.trim()||isLoading; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newSession(){
  messages=[];history=[];sessionTitle='New Session';
  document.getElementById('messages').innerHTML='';
  addMsg('ai','New session started! What would you like to formulate today?');
  switchTab('chat'); toast('New session');
}

function saveSession(){
  if(messages.length<=1){toast('Nothing to save yet',true);return;}
  const e={
    id:Date.now(), title:sessionTitle,
    date:new Date().toLocaleDateString(),
    msgCount:messages.length,
    preview:(messages.find(m=>m.role==='ai'&&m!==messages[0])?.content||'').slice(0,100)+'â€¦',
    messages:messages.slice(), history:history.slice()
  };
  formulas.unshift(e);
  formulas=formulas.slice(0,30);
  localStorage.setItem('cc_formulas',JSON.stringify(formulas));
  renderLib(); toast('âœ… Session saved!');
}

function loadSession(id){
  const f=formulas.find(x=>x.id===id); if(!f)return;
  messages=f.messages.slice(); history=f.history?f.history.slice():[];
  sessionTitle=f.title;
  document.getElementById('messages').innerHTML='';
  messages.forEach(m=>{ if(m.role!=='system')renderMsg(m); });
  switchTab('chat'); scrollBot();
}

function delSession(id){
  formulas=formulas.filter(f=>f.id!==id);
  localStorage.setItem('cc_formulas',JSON.stringify(formulas));
  renderLib(); toast('Deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLib(){
  const list=document.getElementById('lib-list');
  document.getElementById('lib-count').textContent=formulas.length+' saved session'+(formulas.length!==1?'s':'');
  if(!formulas.length){
    list.innerHTML=`<div class="lib-empty"><div class="li-icon">âš—ï¸</div><div class="li-title">No saved formulas yet</div><div class="li-sub">Tap "Save Session" after a formulation</div></div>`;
    return;
  }
  list.innerHTML=formulas.map(f=>`
    <div class="formula-card">
      <div class="fc-top">
        <div>
          <div class="fc-title">${esc(f.title)}</div>
          <div class="fc-meta">${f.date} Â· ${f.msgCount} messages</div>
        </div>
        <div class="fc-actions">
          <button class="load-btn" onclick="loadSession(${f.id})">Load</button>
          <button class="del-btn" onclick="delSession(${f.id})">âœ•</button>
        </div>
      </div>
      <div class="fc-preview">${esc(f.preview)}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
let _tt;
function toast(msg,isErr=false){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=isErr?'err show':'show';
  clearTimeout(_tt); _tt=setTimeout(()=>t.classList.remove('show'),2500);
}
function tryExample(btn){
  switchTab('chat');
  setTimeout(()=>sendText(btn.textContent.replace(/^â†’ /,'').trim()),150);
}
</script>
</body>
</html>
