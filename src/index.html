<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#070d0a" />
  <title>Pro Cosmetic Chemist AI</title>
  <style>
    /* â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      background: #070d0a;
      color: #e8f5e9;
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
    }
    * { scrollbar-width: thin; scrollbar-color: #2d6a4f #0d1a12; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0d1a12; }
    ::-webkit-scrollbar-thumb { background: #2d6a4f; border-radius: 3px; }

    /* â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes bounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-7px)} }
    @keyframes fadeSlide { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    @keyframes spin { to{transform:rotate(360deg)} }
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      height: 60px; min-height: 60px;
      background: rgba(10,26,17,0.95);
      border-bottom: 1px solid rgba(82,183,136,0.15);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      backdrop-filter: blur(8px);
      z-index: 100;
      safe-area-inset-top: env(safe-area-inset-top);
    }
    #header-left { display: flex; align-items: center; gap: 10px; }
    #logo-icon {
      width: 38px; height: 38px; border-radius: 10px;
      background: linear-gradient(135deg, #1b4332, #52b788);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
      box-shadow: 0 0 16px rgba(82,183,136,0.35);
    }
    #logo-text { line-height: 1.2; }
    #logo-title { font-size: 13px; font-weight: 700; color: #a8d8a8; letter-spacing: 0.5px; }
    #logo-sub { font-size: 10px; color: #52b78870; letter-spacing: 1px; }
    #status-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: #52b788; animation: pulse 2s infinite;
    }
    #status-label { font-size: 11px; color: #52b78890; }

    /* â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tabbar {
      display: flex; background: rgba(10,26,17,0.9);
      border-bottom: 1px solid rgba(82,183,136,0.1);
    }
    .tab-btn {
      flex: 1; padding: 10px 4px;
      background: none; border: none;
      color: #52b78870; cursor: pointer;
      font-size: 11px; font-family: inherit;
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn .tab-icon { font-size: 18px; }
    .tab-btn.active {
      color: #a8d8a8;
      border-bottom-color: #52b788;
      background: rgba(82,183,136,0.05);
    }

    /* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    .tab-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .tab-panel.active { display: flex; }

    /* â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #messages {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 12px;
    }
    .msg-row {
      display: flex; align-items: flex-end; gap: 8px;
      animation: fadeSlide 0.3s ease;
    }
    .msg-row.user { flex-direction: row-reverse; }
    .avatar {
      width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
    }
    .avatar.ai {
      background: linear-gradient(135deg, #2d6a4f, #52b788);
      box-shadow: 0 0 10px rgba(82,183,136,0.3);
    }
    .avatar.user {
      background: linear-gradient(135deg, #0d2818, #1b4332);
      border: 1px solid #52b78840;
    }
    .bubble {
      max-width: 80%; padding: 11px 15px;
      font-size: 14px; line-height: 1.7;
    }
    .bubble.ai {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 4px 16px 16px 16px;
      color: #e8f5e9;
    }
    .bubble.user {
      background: linear-gradient(135deg, #1b4332, #2d6a4f);
      border: 1px solid #52b78840;
      border-radius: 16px 16px 4px 16px;
      color: #d8f3dc;
    }
    .msg-time { font-size: 10px; color: #52b78870; margin-top: 4px; }

    /* â”€â”€ MARKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md p { margin: 0 0 8px; }
    .md p:last-child { margin-bottom: 0; }
    .md strong { color: #a8d8a8; font-weight: 700; }
    .md em { color: #74c69d; }
    .md h2 { color: #74c69d; font-size: 1em; margin: 14px 0 6px; border-bottom: 1px solid #52b78830; padding-bottom: 3px; }
    .md h3 { color: #95d5b2; font-size: 0.95em; margin: 10px 0 5px; }
    .md h4 { color: #b7e4c7; font-size: 0.9em; margin: 8px 0 4px; }
    .md ul { margin: 4px 0 8px 16px; }
    .md li { margin-bottom: 3px; }
    .md code { background: rgba(82,183,136,0.15); color: #95d5b2; padding: 1px 5px; border-radius: 4px; font-family: monospace; font-size: 0.88em; }
    .md hr { border: none; border-top: 1px solid #52b78830; margin: 12px 0; }
    .md table { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 12px; }
    .md th { background: rgba(82,183,136,0.2); color: #a8d8a8; font-weight: 700; padding: 6px 8px; text-align: left; border: 1px solid #52b78830; }
    .md td { padding: 5px 8px; border: 1px solid #52b78820; color: #d8f3dc; }
    .md tr:nth-child(even) td { background: rgba(255,255,255,0.02); }

    /* â”€â”€ TYPING INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #typing {
      display: none; align-items: flex-end; gap: 8px;
      padding: 0 16px 8px;
    }
    #typing.visible { display: flex; }
    .dot-wrap {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 4px 16px 16px 16px;
      padding: 12px 16px;
      display: flex; gap: 5px; align-items: center;
    }
    .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: #a8d8a8;
      animation: bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    /* â”€â”€ QUICK PROMPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #quick-wrap {
      padding: 8px 12px 6px;
      border-top: 1px solid rgba(82,183,136,0.08);
      overflow-x: auto; white-space: nowrap;
      display: flex; gap: 7px;
    }
    .quick-btn {
      flex-shrink: 0;
      background: rgba(82,183,136,0.08);
      border: 1px solid rgba(82,183,136,0.22);
      color: #74c69d; border-radius: 20px;
      padding: 5px 12px; cursor: pointer;
      font-size: 12px; font-family: inherit;
      white-space: nowrap;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .quick-btn:active { background: rgba(82,183,136,0.2); transform: scale(0.97); }

    /* â”€â”€ INPUT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-wrap {
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(10,26,17,0.6);
      border-top: 1px solid rgba(82,183,136,0.1);
    }
    #input-row {
      display: flex; gap: 8px; align-items: flex-end;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(82,183,136,0.25);
      border-radius: 16px; padding: 9px 12px;
    }
    #input-row:focus-within { border-color: #52b78860; }
    #msg-input {
      flex: 1; background: none; border: none; outline: none;
      color: #e8f5e9; font-size: 14px; font-family: inherit;
      resize: none; line-height: 1.6; max-height: 100px;
      overflow-y: auto;
    }
    #msg-input::placeholder { color: #52b78858; }
    #send-btn {
      width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
      background: #1b4332; border: 1px solid #52b788;
      color: #a8d8a8; cursor: pointer; font-size: 17px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    #send-btn:disabled { background: rgba(82,183,136,0.08); border-color: #52b78830; color: #52b78840; }
    #send-btn:not(:disabled):active { background: #2d6a4f; transform: scale(0.95); }
    #input-hint { font-size: 10px; color: #52b78848; text-align: center; margin-top: 5px; }

    /* â”€â”€ LIBRARY TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #library-panel { overflow-y: auto; padding: 16px; }
    .lib-header { margin-bottom: 16px; }
    .lib-header h2 { color: #a8d8a8; font-size: 18px; margin-bottom: 4px; }
    .lib-header p { color: #52b78880; font-size: 12px; }
    .lib-empty {
      text-align: center; padding: 50px 20px;
      color: #52b78860; border: 1px dashed rgba(82,183,136,0.2);
      border-radius: 16px; margin-top: 8px;
    }
    .lib-empty .empty-icon { font-size: 40px; margin-bottom: 10px; }
    .lib-empty .empty-title { font-size: 15px; color: #52b788; margin-bottom: 6px; }
    .lib-empty .empty-sub { font-size: 12px; }
    .formula-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(82,183,136,0.18);
      border-radius: 12px; padding: 14px;
      margin-bottom: 10px; transition: border-color 0.2s;
    }
    .formula-card:active { border-color: #52b788; }
    .formula-card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .formula-title { color: #a8d8a8; font-weight: 700; font-size: 14px; margin-bottom: 3px; }
    .formula-meta { color: #52b78880; font-size: 11px; }
    .formula-preview { color: #e8f5e980; font-size: 12px; margin-top: 6px; line-height: 1.5; }
    .card-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .load-btn, .del-btn {
      padding: 5px 11px; border-radius: 7px; cursor: pointer;
      font-size: 11px; font-family: inherit; border: 1px solid;
      -webkit-tap-highlight-color: transparent;
    }
    .load-btn { background: rgba(82,183,136,0.12); border-color: #52b78840; color: #a8d8a8; }
    .del-btn { background: rgba(220,50,50,0.08); border-color: rgba(220,50,50,0.25); color: #ff8a80; }
    #save-bar {
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
      border-top: 1px solid rgba(82,183,136,0.1);
      display: flex; gap: 8px;
    }
    .action-btn {
      flex: 1; padding: 12px; border-radius: 12px;
      border: 1px solid; cursor: pointer;
      font-size: 13px; font-family: inherit; font-weight: 600;
      transition: opacity 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .action-btn:active { opacity: 0.7; }
    .btn-new { background: linear-gradient(135deg, #1b4332, #2d6a4f); border-color: #52b78840; color: #a8d8a8; }
    .btn-save { background: rgba(82,183,136,0.08); border-color: #52b78830; color: #74c69d; }

    /* â”€â”€ GUIDE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #guide-panel { overflow-y: auto; padding: 16px; }
    #guide-panel h2 { color: #a8d8a8; font-size: 18px; margin-bottom: 16px; }
    .guide-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(82,183,136,0.13);
      border-radius: 12px; padding: 14px;
      margin-bottom: 10px; display: flex; gap: 12px;
    }
    .guide-icon { font-size: 24px; flex-shrink: 0; line-height: 1; margin-top: 2px; }
    .guide-title { color: #a8d8a8; font-weight: 700; margin-bottom: 4px; font-size: 14px; }
    .guide-body { color: #d8f3dc80; font-size: 13px; line-height: 1.6; }
    .example-box {
      background: rgba(82,183,136,0.06);
      border: 1px solid rgba(82,183,136,0.2);
      border-radius: 12px; padding: 16px; margin-top: 16px;
    }
    .example-box h3 { color: #74c69d; font-size: 14px; font-weight: 700; margin-bottom: 10px; }
    .example-prompt {
      display: block; width: 100%;
      background: none; border: none; border-bottom: 1px solid rgba(82,183,136,0.1);
      color: #74c69d80; text-align: left; cursor: pointer;
      padding: 8px 0; font-size: 12px; font-family: inherit;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .example-prompt:last-child { border-bottom: none; }
    .example-prompt:active { color: #a8d8a8; }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: rgba(45,106,79,0.95); color: #a8d8a8;
      padding: 10px 20px; border-radius: 20px; font-size: 13px;
      border: 1px solid #52b788; pointer-events: none;
      opacity: 0; transition: opacity 0.3s; z-index: 1000;
      white-space: nowrap;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div id="header-left">
    <div id="logo-icon">âš—ï¸</div>
    <div id="logo-text">
      <div id="logo-title">PRO CHEMIST AI</div>
      <div id="logo-sub">FORMULATION EXPERT</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:6px;">
    <div id="status-dot"></div>
    <span id="status-label">AI Online</span>
  </div>
</div>

<!-- TAB BAR -->
<div id="tabbar">
  <button class="tab-btn active" data-tab="chat" onclick="switchTab('chat')">
    <span class="tab-icon">ğŸ’¬</span>Chat
  </button>
  <button class="tab-btn" data-tab="library" onclick="switchTab('library')">
    <span class="tab-icon">ğŸ“š</span>Library
  </button>
  <button class="tab-btn" data-tab="guide" onclick="switchTab('guide')">
    <span class="tab-icon">ğŸ“–</span>Guide
  </button>
</div>

<!-- MAIN -->
<div id="main">

  <!-- CHAT PANEL -->
  <div id="chat" class="tab-panel active">
    <div id="messages"></div>
    <div id="typing">
      <div class="avatar ai">ğŸ‘©â€ğŸ”¬</div>
      <div class="dot-wrap">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>
    <div id="quick-wrap"></div>
    <div id="input-wrap">
      <div id="input-row">
        <textarea id="msg-input" rows="1"
          placeholder="Describe the product you want to formulateâ€¦"
          oninput="autoResize(this)"
          onkeydown="handleKey(event)"></textarea>
        <button id="send-btn" disabled onclick="sendMessage()">â†‘</button>
      </div>
      <div id="input-hint">Powered by Claude Sonnet 4 Â· Expert Cosmetic Chemist AI</div>
    </div>
  </div>

  <!-- LIBRARY PANEL -->
  <div id="library" class="tab-panel" style="flex-direction:column;">
    <div id="library-panel" style="flex:1;overflow-y:auto;padding:16px;">
      <div class="lib-header">
        <h2>ğŸ“š Formula Library</h2>
        <p id="lib-count">0 saved sessions</p>
      </div>
      <div id="lib-list"></div>
    </div>
    <div id="save-bar">
      <button class="action-btn btn-new" onclick="newSession()">+ New Session</button>
      <button class="action-btn btn-save" onclick="saveSession()">ğŸ’¾ Save Session</button>
    </div>
  </div>

  <!-- GUIDE PANEL -->
  <div id="guide" class="tab-panel" style="overflow-y:auto;">
    <div id="guide-panel">
      <h2>ğŸ“– How to Use</h2>
      <div class="guide-card"><div class="guide-icon">ğŸ§ª</div><div><div class="guide-title">Request a Formula</div><div class="guide-body">Describe the product type, skin/hair concern, key actives, and any restrictions. The AI generates a complete batch-ready formula with INCI list, percentages, and process notes.</div></div></div>
      <div class="guide-card"><div class="guide-icon">âš—ï¸</div><div><div class="guide-title">Batch Process Design</div><div class="guide-body">Every formula includes phase temperatures, mixing speeds, order of addition, and finishing steps â€” ready for lab or pilot-scale manufacturing.</div></div></div>
      <div class="guide-card"><div class="guide-icon">ğŸ”„</div><div><div class="guide-title">Modify & Iterate</div><div class="guide-body">Ask to swap ingredients, adjust percentages, go natural/vegan, reduce cost, or create premium variations. The AI updates formulas in real time.</div></div></div>
      <div class="guide-card"><div class="guide-icon">ğŸ“Š</div><div><div class="guide-title">Stability & Regulatory</div><div class="guide-body">Get pH targets, preservation system justification, compatibility notes, shelf-life expectations, and EU/US regulatory guidance for every formula.</div></div></div>
      <div class="guide-card"><div class="guide-icon">ğŸ’¾</div><div><div class="guide-title">Save Your Work</div><div class="guide-body">Tap "Save Session" in the Library tab to store your formulation. Access all saved formulas anytime in the Library.</div></div></div>
      <div class="example-box">
        <h3>ğŸ’¡ Tap to Try These Examples</h3>
        <button class="example-prompt" onclick="tryExample(this)">â†’ 2% salicylic acid toner for acne-prone skin, alcohol-free</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Natural SPF 30 mineral sunscreen â€” non-nano zinc oxide, EU compliant</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Vegan, Cosmos-certified hair conditioner for curly hair</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Vitamin C serum with L-ascorbic acid at pH 3.2, stable for 18 months</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Reformulate this formula to be silicone-free and cost-reduced by 20%</button>
        <button class="example-prompt" onclick="tryExample(this)">â†’ Rich body butter for very dry skin with ceramides and shea</button>
      </div>
    </div>
  </div>

</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SYSTEM_PROMPT = `You are an expert cosmetic chemist with deep experience in R&D, formulation science, raw material selection, stability considerations, regulatory constraints, and manufacturing processes. You think like a senior formulator who creates real-world, batch-ready cosmetic formulas.

When the user provides requirements, you must:
1. Generate a complete cosmetic formula with: product type and function, full INCI list, percentage composition (total = 100%), phase-by-phase breakdown, ingredient rationale, and recommended substitutes.
2. Provide a detailed demo batch process: phase temperatures, mixing speeds, order of addition, emulsification steps, cooling and finishing steps.
3. Explain stability considerations: pH targets, preservation system justification, viscosity expectations, compatibility notes.
4. Adapt to user constraints: ingredient restrictions, natural/organic preferences, cost limits, regional regulatory limitations.

Formula Output Format â€” always use this structure:

**1. Product Overview**
- Product type
- Key claims
- Texture/viscosity expectations
- Skin/hair type suitability

**2. Full Formula (100%)**
| Phase | INCI Name | Trade Name | % | Function |

**3. Ingredient Rationale**
Short explanation for each key ingredient.

**4. Demo Batch Process**
Step-by-step manufacturing instructions with temperatures, mixing notes, and finishing steps.

**5. Stability & Regulatory Notes**
- pH range
- Preservation system justification
- Known incompatibilities
- Expected shelf life

**6. Optional Variations**
- Cost-reduced version
- Premium version
- Natural/clean version

After every formula, ask: "Would you like to modify any ingredients, adjust the texture, change the claims, or create variations?"

Be precise, technical, and practical. Never hallucinate nonexistent ingredients or unsafe combinations.`;

const QUICK_PROMPTS = [
  { icon: "ğŸ§´", label: "Moisturizer", prompt: "Formulate a lightweight moisturizer for oily skin with niacinamide and hyaluronic acid." },
  { icon: "ğŸ§¼", label: "Cleanser", prompt: "Create a gentle sulfate-free facial cleanser for sensitive skin." },
  { icon: "â˜€ï¸", label: "SPF 30", prompt: "Formulate an SPF 30 broad-spectrum sunscreen â€” EU-compliant, elegant skin feel." },
  { icon: "ğŸ’†", label: "Shampoo", prompt: "Design a sulfate-free shampoo for damaged hair with protein complex." },
  { icon: "âœ¨", label: "Serum", prompt: "Create a 10% Vitamin C serum with ferulic acid for enhanced stability, pH 3.2." },
  { icon: "ğŸ’„", label: "Lip Balm", prompt: "Formulate a nourishing lip balm with SPF 15, natural waxes, and a subtle tint." },
  { icon: "ğŸ«§", label: "Body Lotion", prompt: "Develop a rich body lotion for dry skin with ceramides and shea butter." },
  { icon: "ğŸŒ¿", label: "Natural", prompt: "95%+ natural face oil serum for mature skin â€” Cosmos-certified, no synthetics." },
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let messages = [];
let history = [];
let sessionTitle = "New Session";
let formulas = [];
let isLoading = false;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  loadFormulas();
  buildQuickPrompts();
  addWelcome();
  document.getElementById('msg-input').addEventListener('input', updateSendBtn);
});

function addWelcome() {
  addMessage('ai', `Welcome to **Pro Cosmetic Chemist AI** â€” your senior formulation expert.\n\nI can help you:\n- ğŸ§ª **Formulate** any cosmetic product (skincare, haircare, color, sun care)\n- âš—ï¸ **Design batch processes** with phase temperatures & mixing protocols\n- ğŸ“Š **Optimize stability**, preservation, and pH targets\n- ğŸŒ¿ **Adapt** to natural, vegan, cost-reduced, or premium requirements\n- ğŸ“‹ **Review** and improve your existing formulas\n\nTell me what you'd like to create, or tap a quick-start button below.`);
}

function buildQuickPrompts() {
  const wrap = document.getElementById('quick-wrap');
  QUICK_PROMPTS.forEach(q => {
    const btn = document.createElement('button');
    btn.className = 'quick-btn';
    btn.textContent = q.icon + ' ' + q.label;
    btn.onclick = () => sendText(q.prompt);
    wrap.appendChild(btn);
  });
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === name));
  if (name === 'library') renderLibrary();
}

// â”€â”€ MESSAGING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMessage(role, content) {
  const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const obj = { role, content, time };
  messages.push(obj);
  if (role !== 'system') renderMessage(obj);
  if (role === 'user' || role === 'assistant') {
    history.push({ role, content });
  }
  scrollBottom();
  return obj;
}

function renderMessage(msg) {
  const container = document.getElementById('messages');
  const row = document.createElement('div');
  row.className = 'msg-row ' + (msg.role === 'user' ? 'user' : 'ai');
  const av = document.createElement('div');
  av.className = 'avatar ' + (msg.role === 'user' ? 'user' : 'ai');
  av.textContent = msg.role === 'user' ? 'ğŸ§‘â€ğŸ’¼' : 'ğŸ‘©â€ğŸ”¬';
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (msg.role === 'user' ? 'user' : 'ai');
  if (msg.role === 'ai' || msg.role === 'assistant') {
    const md = document.createElement('div');
    md.className = 'md';
    md.innerHTML = renderMarkdown(msg.content);
    bubble.appendChild(md);
  } else {
    bubble.textContent = msg.content;
  }
  const timeEl = document.createElement('div');
  timeEl.className = 'msg-time';
  timeEl.textContent = msg.time;
  bubble.appendChild(timeEl);
  if (msg.role === 'user') { row.appendChild(bubble); row.appendChild(av); }
  else { row.appendChild(av); row.appendChild(bubble); }
  container.appendChild(row);
}

function renderMarkdown(text) {
  let html = text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^### (.+)$/gm,'<h4>$1</h4>')
    .replace(/^## (.+)$/gm,'<h3>$1</h3>')
    .replace(/^# (.+)$/gm,'<h2>$1</h2>')
    .replace(/`(.+?)`/g,'<code>$1</code>')
    .replace(/^- (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>[\s\S]+?<\/li>\n?)+/g, m => '<ul>'+m+'</ul>')
    .replace(/^---$/gm,'<hr>')
    .replace(/^\|(.+)\|$/gm, row => {
      const cells = row.split('|').slice(1,-1);
      const isDivider = cells.every(c => /^[-: ]+$/.test(c.trim()));
      if (isDivider) return '';
      const isHeader = cells.some(c => c.trim() === 'Phase' || c.trim() === 'INCI Name');
      const tag = isHeader ? 'th' : 'td';
      return '<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>';
    })
    .replace(/(<tr>[\s\S]+?<\/tr>\n?)+/g, m => '<table>'+m+'</table>')
    .replace(/\n\n/g,'</p><p>')
    .replace(/\n/g,'<br>');
  return '<p>'+html+'</p>';
}

function scrollBottom() {
  setTimeout(() => {
    const el = document.getElementById('messages');
    el.scrollTop = el.scrollHeight;
  }, 50);
}

function setTyping(show) {
  document.getElementById('typing').classList.toggle('visible', show);
  if (show) scrollBottom();
}

// â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function sendMessage() {
  const input = document.getElementById('msg-input');
  sendText(input.value.trim());
  input.value = '';
  input.style.height = 'auto';
  updateSendBtn();
}

async function sendText(text) {
  if (!text || isLoading) return;
  if (messages.length <= 1) {
    sessionTitle = text.slice(0, 40) + (text.length > 40 ? 'â€¦' : '');
  }
  addMessage('user', text);
  isLoading = true;
  setTyping(true);
  document.getElementById('send-btn').disabled = true;

  try {
    const apiMessages = history.slice();
    const reply = await callClaude(apiMessages);
    addMessage('ai', reply);
  } catch (err) {
    addMessage('ai', 'âš ï¸ Error: ' + err.message + '. Please check your connection and try again.');
  } finally {
    isLoading = false;
    setTyping(false);
    updateSendBtn();
  }
}

async function callClaude(msgs) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4096,
      system: SYSTEM_PROMPT,
      messages: msgs,
    })
  });
  if (!resp.ok) throw new Error('API error ' + resp.status);
  const data = await resp.json();
  return data.content.map(b => b.text || '').join('');
}

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function updateSendBtn() {
  const v = document.getElementById('msg-input').value.trim();
  document.getElementById('send-btn').disabled = !v || isLoading;
}

// â”€â”€ SESSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newSession() {
  messages = [];
  history = [];
  sessionTitle = 'New Session';
  document.getElementById('messages').innerHTML = '';
  addWelcome();
  switchTab('chat');
  showToast('New session started');
}

function saveSession() {
  if (messages.length <= 1) { showToast('Nothing to save yet'); return; }
  const entry = {
    id: Date.now(),
    title: sessionTitle,
    date: new Date().toLocaleDateString(),
    msgCount: messages.length,
    preview: (messages.find(m => m.role === 'ai' && m !== messages[0])?.content || '').slice(0, 100) + 'â€¦',
    messages: messages.slice(),
    history: history.slice(),
  };
  formulas.unshift(entry);
  formulas = formulas.slice(0, 30);
  persistFormulas();
  renderLibrary();
  showToast('Session saved!');
}

function loadSession(id) {
  const f = formulas.find(x => x.id === id);
  if (!f) return;
  messages = f.messages.slice();
  history = f.history ? f.history.slice() : [];
  sessionTitle = f.title;
  document.getElementById('messages').innerHTML = '';
  messages.forEach(m => {
    if (m.role !== 'system') renderMessage(m);
  });
  switchTab('chat');
  scrollBottom();
}

function deleteFormula(id) {
  formulas = formulas.filter(f => f.id !== id);
  persistFormulas();
  renderLibrary();
  showToast('Deleted');
}

// â”€â”€ LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLibrary() {
  const list = document.getElementById('lib-list');
  const count = document.getElementById('lib-count');
  count.textContent = formulas.length + ' saved session' + (formulas.length !== 1 ? 's' : '');
  if (formulas.length === 0) {
    list.innerHTML = `<div class="lib-empty"><div class="empty-icon">âš—ï¸</div><div class="empty-title">No saved formulas yet</div><div class="empty-sub">Create a formula then tap "Save Session"</div></div>`;
    return;
  }
  list.innerHTML = formulas.map(f => `
    <div class="formula-card">
      <div class="formula-card-top">
        <div>
          <div class="formula-title">${escHtml(f.title)}</div>
          <div class="formula-meta">${f.date} Â· ${f.msgCount} messages</div>
        </div>
        <div class="card-actions">
          <button class="load-btn" onclick="loadSession(${f.id})">Load</button>
          <button class="del-btn" onclick="deleteFormula(${f.id})">âœ•</button>
        </div>
      </div>
      <div class="formula-preview">${escHtml(f.preview)}</div>
    </div>
  `).join('');
}

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFormulas() {
  try {
    const r = await window.storage.get('formulas_app_v1');
    if (r) formulas = JSON.parse(r.value);
  } catch {}
}

async function persistFormulas() {
  try { await window.storage.set('formulas_app_v1', JSON.stringify(formulas)); } catch {}
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function tryExample(btn) {
  const text = btn.textContent.replace(/^â†’ /, '').trim();
  switchTab('chat');
  setTimeout(() => sendText(text), 150);
}
</script>
</body>
</html>
